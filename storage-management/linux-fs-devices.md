# Linux Filesystems and Devices

- fuser -v `/mnt/files` (you can use also lsof)
- lsof  | head
- lsblk -f
- mount -o remount,rw /mnt/data



- 1 (dump the filesystem 1 enable)
- 1 (fsck first, 2 check next)

```
UUID=uid1 / 	xfs defaults 1 1
/dev/nvme0n1p1  	/mnt/data 	ext4  defaults 0 0
```

## SWAP

- `swapon --show` -2 indicates the priority
-  `cat /proc/swap`
- `mkswap /dev/sdb1 && swapon /dev/sdb1`
- `echo "UUID=uuid" swap swap sw 0 0 >> /etc/fstab` 

## SystemD Mounts units

- Go to `/run/systemd/generator`

```
# Automatically generated by systemd-fstab-generator

[Unit]
Documentation=man:fstab(5) man:systemd-fstab-generator(8)
SourcePath=/etc/fstab
Before=local-fs.target
After=blockdev@dev-disk-by\x2duuid-3879fb18\x2d9d4e\x2d4b79\x2d88be\x2d2fa4afb50c2b.target

[Mount]
Where=/mnt/training
What=/dev/disk/by-uuid/3879fb18-9d4e-4b79-88be-2fa4afb50c2b
Type=ext4
```

For each entry in `/etc/fstab` there is a `.mount` file. This can be managed with 

```bash
systemctl status mnt-training.mount
● mnt-training.mount - /mnt/training
     Loaded: loaded (/etc/fstab; generated)
     Active: active (mounted) since Tue 2020-07-14 08:57:41 CEST; 11h ago
      Where: /mnt/training
       What: /dev/mapper/crucial_p1-training
       Docs: man:fstab(5)
             man:systemd-fstab-generator(8)
      Tasks: 0 (limit: 38377)
     Memory: 472.0K
     CGroup: /system.slice/mnt-training.mount

Jul 14 08:57:41 void systemd[1]: Mounting /mnt/training...
Jul 14 08:57:41 void systemd[1]: Mounted /mnt/training.
```


If you create your unit, the mount path must match the name of the `mount point`.

```systemctl status data.mount
● data.mount - Data mount
   Loaded: error (Reason: Invalid argument)
   Active: inactive (dead)
    Where: /mnt/data
     What: /dev/disk/by-uuid/40ef2df4-a332-4897-8d93-8cfc56ec30cc

Jul 14 14:43:57 centos-server systemd[1]: data.mount's Where= setting doesn't match unit name. Refusing.
```
The unit below

```
[Unit]
Description=Data mount

[Mount]
What=/dev/disk/by-uuid/filesystem_UUID
Where=/mnt/data
Type=xfs (or ext4)
Options=defaults

[Install]
WantedBy=multi-user.target
```

If you want to create and automount You need to stop/disable the previous mount unit or it will fail.

```bash
[cloud_user@centos-server ~]$ sudo systemctl  status mnt-data.automount
● mnt-data.automount
   Loaded: loaded
   Active: inactive (dead)
    Where: /mnt/data

Jul 14 14:48:54 centos-server systemd[1]: Path /mnt/data is already a mount point, refusing start for mnt-data.automount
Jul 14 14:48:54 centos-server systemd[1]: Failed to set up automount mnt-data.automount.
[cloud_user@centos-server ~]$ sudo systemctl  start  mnt-data.automount
[cloud_user@centos-server ~]$ sudo systemctl  status mnt-data.automount
● mnt-data.automount
   Loaded: loaded
   Active: active (waiting) since Tue 2020-07-14 14:49:36 EDT; 1s ago
    Where: /mnt/data
```

# Filesystems

## Ext2 ext3 ext4

- You can create with `mkfs -t filesystemType` 
- Use `parted` to create the partitions.
- EXT2 needs to be unmounted to run `fsck`
- `tune2fs -l /dev/nvme1n1p2`
- Reserved count to 0 `tune2fs -m 0 /dev/nvme1n1p2`
- Label `tun2fs -L volName /dev/nvme1n1p2`
- Convert ext2 -> ext3  `tune2fs -j /dev/nvme1n1p1`
- Remove journal `tune2fs -O ^has_journal /dev/nvme1n1p1`
- Superblock `dump2fs /dev/nvme1n1p2`
- Debugfs `debugfs /dev/nvme1p1p1`


